<html>
	<head>
		<style>
			#timer-anim {
				border: solid black 2px;
			}
		</style>
	</head>
	<body>
		<div>
			<h2>Animation</h2>
			<canvas id="timer-anim" width="320" height="240"></canvas>
			<button onclick="startAnim()">Start animation!</startAnim>
		</div>

		<div>
			<h2>Audio</h2>
			<div class="objurl">
				<h3>1. Object URL audio</h3>
				<audio controls id="objurl-audio"></audio>
			</div>

			<div class="standard">
				<h3>2. Standard audio</h3>
				<audio src="./aud.mp3" controls></audio>
			</div>

			<div class="click">
				<h3>Play cached on click</h3>
				<button onclick="audio.play_cached()">Play</button>
			</div>

			<div class="click">
				<h3>Play fresh on click</h3>
				<button onclick="audio.play_fresh()">Play</button>
			</div>
		</div>

		<div>
			<h2>Video</h2>
			<div class="objurl">
				<h3>1. Object URL video</h3>
				<video controls id="objurl-video"></video>
			</div>

			<div class="standard">
				<h3>2. Standard video</h3>
				<video src="./vid.mp4" controls></video>
			</div>
		</div>

		<script>
			var audio = (function() {
				var cached = loadSound();

				function loadSound() {
					return new Audio('aud.mp3');
				}

				return {
					play_fresh: function() { loadSound().play(); },
					play_cached: function() { cached.play(); },
				};
			}());

			function setSrcBlob(elementId, url) {
				var request = new XMLHttpRequest();
				request.onreadystatechange = function(event) {
					if(request.readyState === XMLHttpRequest.DONE) {
						var blob = request.response;
						var objUrl = URL.createObjectURL(blob);
						document.getElementById(elementId).setAttribute('src', objUrl);
					}
				}
				request.responseType = 'blob';
				request.open('GET', url, true);
				request.send();
			}

			setSrcBlob('objurl-video', './vid.mp4');
			setSrcBlob('objurl-audio', './aud.mp3');
		</script>
		<script>
			var pi = Math.PI,
			    LIM = 3000; // Half of the time the animation should take

		//> ANIMATION HELPERS
			function toHex() {
				var hex;
				if(arguments.length === 1) {
					hex = Math.round(arguments[0]).toString(16);
					if(hex.length === 1) hex = '0' + hex;
					return hex;
				}
				return toHex(arguments[0]) +
						toHex(arguments[1]) +
						toHex(arguments[2]);
			}

			function drawCircle(ctx, c) {
				ctx.beginPath();
				ctx.arc(c.x, c.y, c.r, 0, 2*pi, false);
				ctx.fillStyle = c.color;
				ctx.fill();
			}

			function rgb(r, g, b) { return { r:r, g:g, b:b }; }

			function fade(offset, limit, start, end) {
				return toHex(
					start.r + ((end.r - start.r) * offset / limit),
					start.g + ((end.g - start.g) * offset / limit),
					start.b + ((end.b - start.b) * offset / limit));
			}

		//> THE ANIMATION ITSELF
			function drawAnimation(canvas, context, offset) {
				var bigColor, littleOffset;

				// draw big coloured circle
				if(offset < LIM) {
					// big color between blue & grey
					bigColor = '#' + fade(offset, LIM, rgb(0, 0, 255), rgb(176, 176, 176));
				} else {
					// big color between gray & orange
					bigColor = '#' + fade(offset - LIM, LIM, rgb(176, 176, 176), rgb(255, 165, 0));
				}
				drawCircle(ctx, {
					x: 160, y: 120, r: 120, color: bigColor });

				// draw little white circle
				littleOffset = {
					x: 75 * Math.sin(pi*offset/LIM),
					y: 75 * Math.cos(pi*offset/LIM),
				};
				drawCircle(ctx, {
					x: 160 + littleOffset.x,
					y: 120 - littleOffset.y,
					r: 15,
					color: 'white'
				});
			}

			function startAnim() {
				setTimeout(function() {
					animate(canvas, ctx, Date.now());
				}, 0);
			}

			function animate(canvas, ctx, start) {
				var offset = Date.now() - start;

				if(offset < LIM*2) {
					drawAnimation(canvas, ctx, offset);
					requestAnimationFrame(function() {
						animate(canvas, ctx, start);
					});
				} else {
					drawAnimation(canvas, ctx, LIM*2);
					ping.play();
				}
			}

			var canvas = document.getElementById('timer-anim');
			var ctx = canvas.getContext('2d');
			var ping = new Audio('./aud.mp3');

			drawAnimation(canvas, ctx, 0);

			ping.play();
		</script>
	</body>
</html>
