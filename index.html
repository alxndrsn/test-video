<html>
	<head>
		<style>
			#timer-anim {
				border: solid black 2px;
			}
			div.audio, div.video {
				display: none;
			}
			button {
				font-size: 24px;
				border: solid 2px black;
				border-radius: 4px;
			}
		</style>
	</head>
	<body>
		<h4>Version: 15</h4>
		<div class="anim">
			<h2>Animation</h2>
			<canvas id="timer-anim" width="320" height="320"></canvas>
			<br>
			<button onclick="startTimer()">Start animation!</button>
		</div>

		<div class="buttons">
			<h2>Play:</h2>
			<button onclick="audio.play_fresh_object()">Fresh Object</button>
			<button onclick="audio.play_cached_object()">Cached Object</button>
			<button onclick="audio.play_visible_element()">Visible Element</button>
			<button onclick="audio.play_fresh_element()">Fresh Element</button>
		</div>

		<div class="audio">
			<h2>Audio</h2>
			<div class="objurl">
				<h3>1. Object URL audio</h3>
				<audio controls id="objurl-audio"></audio>
			</div>

			<div class="standard">
				<h3>2. Standard audio</h3>
				<audio id="standard-audio" src="./aud.mp3" controls preload="auto" autobuffer="true" muted="false"></audio>
			</div>

			<div class="click">
				<h3>Play cached on click</h3>
				<button onclick="audio.play_cached()">Play</button>
			</div>

			<div class="click">
				<h3>Play fresh on click</h3>
				<button onclick="audio.play_fresh()">Play</button>
			</div>
		</div>

		<div class="video">
			<h2>Video</h2>
			<div class="objurl">
				<h3>1. Object URL video</h3>
				<video controls id="objurl-video"></video>
			</div>

			<div class="standard">
				<h3>2. Standard video</h3>
				<video src="./vid.mp4" controls></video>
			</div>
		</div>

		<script>
			var audio = (function() {
				var cached = loadSound();

				function loadSound() {
					return new Audio('aud.mp3');
				}

				return {
					play_fresh_object: function() { loadSound().play(); },
					play_cached_object: function() { cached.volume = 1; cached.play(); },
					play_cached_silently: function() { cached.volume = 0; cached.play(); },
					play_visible_element: function() {
						document.getElementById('standard-audio').volume = 1;
						document.getElementById('standard-audio').muted = false;
						document.getElementById('standard-audio').play();
					},
					play_fresh_element: function() {
						var e = document.createElement('audio');
						e.src = './aud.mp3';
						e.play();
					},
				};
			}());

			function setSrcBlob(elementId, url) {
				var request = new XMLHttpRequest();
				request.onreadystatechange = function(event) {
					if(request.readyState === XMLHttpRequest.DONE) {
						var blob = request.response;
						var objUrl = URL.createObjectURL(blob);
						document.getElementById(elementId).setAttribute('src', objUrl);
					}
				}
				request.responseType = 'blob';
				request.open('GET', url, true);
				request.send();
			}

			setSrcBlob('objurl-video', './vid.mp4');
			setSrcBlob('objurl-audio', './aud.mp3');
		</script>
		<script>
			var pi = Math.PI,
			    LIM = 1000, // Half of the time the animation should take
			    canvasW = document.getElementById('timer-anim').width,
			    canvasH = document.getElementById('timer-anim').height,
			    centre = { x: canvasW/2, y: canvasH/2 },
			    bigR = Math.min(canvasW, canvasH) / 2,
			    littleR = bigR / 8,
			    littleOffsetMax = bigR - 3*littleR,
			    startColor = rgb(0, 0, 255),
			    midColor = rgb(176, 176, 176),
			    endColor = rgb(255, 165, 0);

		//> ANIMATION HELPERS
			function toHex() {
				var hex;
				if(arguments.length === 1) {
					hex = Math.round(arguments[0]).toString(16);
					if(hex.length === 1) hex = '0' + hex;
					return hex;
				}
				return toHex(arguments[0]) +
						toHex(arguments[1]) +
						toHex(arguments[2]);
			}

			function drawCircle(ctx, c) {
				ctx.beginPath();
				ctx.arc(c.x, c.y, c.r, 0, 2*pi, false);
				ctx.fillStyle = c.color;
				ctx.fill();
			}

			function rgb(r, g, b) { return { r:r, g:g, b:b }; }

			function fade(offset, limit, start, end) {
				return toHex(
					start.r + ((end.r - start.r) * offset / limit),
					start.g + ((end.g - start.g) * offset / limit),
					start.b + ((end.b - start.b) * offset / limit));
			}

		//> THE ANIMATION ITSELF
			function drawAnimation(canvas, context, offset) {
				var bigColor, littleOffset;

				// draw big coloured circle
				if(offset < LIM) {
					// big color between blue & grey
					bigColor = '#' + fade(offset, LIM, startColor, midColor);
				} else {
					// big color between gray & orange
					bigColor = '#' + fade(offset - LIM, LIM, midColor, endColor);
				}
				drawCircle(ctx, {
					x: centre.x, y: centre.y, r: bigR, color: bigColor });

				// draw little white circle
				littleOffset = {
					x: littleOffsetMax * Math.sin(pi*offset/LIM),
					y: littleOffsetMax * Math.cos(pi*offset/LIM),
				};
				drawCircle(ctx, {
					x: centre.x + littleOffset.x,
					y: centre.y - littleOffset.y,
					r: littleR,
					color: 'white'
				});
			}

			function startTimer() {
				running = true;
				setTimeout(function() {
					animate(canvas, ctx, Date.now());
				}, 0);
				audio.play_cached_silently();
			}

			function animate(canvas, ctx, start) {
				var offset = Date.now() - start;

				if(!running) return;

				if(offset < LIM*2) {
					drawAnimation(canvas, ctx, offset);
					requestAnimationFrame(function() {
						animate(canvas, ctx, start);
					});
				} else {
					drawAnimation(canvas, ctx, LIM*2);
					running = false;

					audio.play_cached_object();
				}
			}

			var canvas = document.getElementById('timer-anim');
			var ctx = canvas.getContext('2d');
			var running = false;

			function resetTimer() {
				running = false;
				drawAnimation(canvas, ctx, 0);
			}
			resetTimer();

			canvas.addEventListener('click', function() {
				if(running) resetTimer();
				else startTimer();
			});
		</script>
	</body>
</html>
